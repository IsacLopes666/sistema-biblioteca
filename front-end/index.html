<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Biblioteca Digital</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!--  CABEÇALHO  -->
  <header>
    <h1>📚 Biblioteca Digital</h1>
    <nav id="menu" style="display:none;">
      <a href="#" id="goList"> Lista de Livros</a>
      <a href="#" id="goRegister">Cadastrar Livro</a>
    </nav>
    <div id="userInfo">
      <span id="userName"></span>
      <button id="logoutBtn" style="display:none;">Sair da Conta</button>
    </div>
  </header>

  <main>
    <!--  Login  -->
    <section id="login-section" class="active">
      <h2>Login</h2>
      <form id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email" required>
        <input type="password" id="loginPassword" placeholder="Senha" required>
        <button type="submit">Entrar</button>
      </form>
      <p>Não tem conta? <a href="#" id="showRegister">Cadastre-se</a></p>
    </section>

    <!--  Cadastro De Usuario  -->
    <section id="register-section">
      <h2>Cadastro De Usuario</h2>
      <form id="registerForm">
        <input type="text" id="regName" placeholder="Nome" required>
        <input type="email" id="regEmail" placeholder="Email" required>
        <input type="password" id="regPassword" placeholder="Senha" required>
        <button type="submit">Cadastrar</button>
      </form>
      <p>Já tem conta? <a href="#" id="showLogin">Faça login</a></p>
    </section>

    <!--  Lista De Livros -->
    <section id="list-section">
      <h2>Lista de Livros</h2>
      <ul id="bookList"></ul>
    </section>

    <!--  Cadastrar Livro -->
    <section id="system-section">
      <h2>Cadastrar Livro</h2>
      <div class="card-form">
        <form id="bookForm">
          <input type="text" id="title" placeholder="Título" required>
          <input type="text" id="author" placeholder="Autor" required>
          <input type="text" id="genre" placeholder="Gênero" required>
          <input type="number" id="year" placeholder="Ano" required>
          <textarea id="description" placeholder="Descrição" required></textarea>
          <input type="file" id="image" accept="image/*">
          <button type="submit">Adicionar Livro</button>
        </form>
        <div class="preview-container">
          <img id="preview" src="" alt="Preview da capa" style="display:none;">
        </div>
      </div>
    </section>
  </main>

  <!--  Modal de Visualizar/Editar  -->
  <div id="modal" class="modal">
    <div class="modal-content">
      <span id="closeModal">&times;</span>
      <h3 id="modalTitle"></h3>
      <div id="viewContent" style="display:none;">
        <p><strong>Título:</strong> <span id="viewTitle"></span></p>
        <p><strong>Autor:</strong> <span id="viewAuthor"></span></p>
        <p><strong>Gênero:</strong> <span id="viewGenre"></span></p>
        <p><strong>Ano:</strong> <span id="viewYear"></span></p>
        <p><strong>Descrição:</strong> <span id="viewDescription"></span></p>
        <img id="viewImage" src="" alt="Capa" style="max-width:120px; margin-top:10px;">
      </div>
      <form id="editForm" style="display:none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Título</label>
            <input type="text" id="editTitle" placeholder="Título do livro" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Gênero</label>
            <input type="text" id="editGenre" placeholder="Gênero do livro" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Autor</label>
            <input type="text" id="editAuthor" placeholder="Nome do autor" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
          
          <div>
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ano</label>
            <input type="number" id="editYear" placeholder="Ano de publicação" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
          </div>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Descrição</label>
          <textarea id="editDescription" placeholder="Descrição do livro" required style="width: 100%; height: 100px; padding: 8px; border: 1px solid #ccc; border-radius: 4px;"></textarea>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">Imagem do Livro</label>
          <input type="file" id="editImage" accept="image/*" style="margin-bottom: 10px;">
          <img id="editPreview" src="" alt="Preview da capa" style="max-width: 120px; display: block; border-radius: 6px;">
        </div>
        
        <button type="submit" style="margin-top: 10px; width: 100%; padding: 10px; background: #004080; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer;">Salvar Alterações</button>
      </form>
    </div>
  </div>

  <!--  Modal de Confirmação  -->
  <div id="confirmModal" class="modal">
    <div class="modal-content">
      <h3>Confirmação</h3>
      <p id="confirmMessage">Você deseja realmente remover este livro?</p>
      <div style="margin-top:15px; display:flex; justify-content:flex-end; gap:10px;">
        <button id="cancelDelete" style="background:#6c757d;">Cancelar</button>
        <button id="confirmDelete" style="background:#dc3545;">Remover</button>
      </div>
    </div>
  </div>

  <div id="toast-container"></div>

  <script>
  const API_URL = "http://localhost:3000";
  let currentUser = null;
  let editingBook = null;
  let bookToDelete = null;

  function showToast(message, type = "info") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.classList.add("toast", type);
    toast.textContent = message;
    container.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }

  // Troca entre login e cadastro
  document.getElementById("showRegister").addEventListener("click", () => {
    document.getElementById("login-section").classList.remove("active");
    document.getElementById("register-section").classList.add("active");
  });
  document.getElementById("showLogin").addEventListener("click", () => {
    document.getElementById("register-section").classList.remove("active");
    document.getElementById("login-section").classList.add("active");
  });

  // Cadastro de usuário
  document.getElementById("registerForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = document.getElementById("regName").value;
    const email = document.getElementById("regEmail").value;
    const password = document.getElementById("regPassword").value;

    // Verifica se usuário já existe
    const usersRes = await fetch(`${API_URL}/usuarios`);
    const users = await usersRes.json();
    const userExists = users.find(u => u.email === email);
    
    if (userExists) {
      showToast("Este email já está cadastrado!", "error");
      return;
    }

    // Cadastra o usuário
    await fetch(`${API_URL}/usuarios`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        nome: name, 
        email, 
        senha: password 
      }),
    });

    showToast("Cadastro realizado com sucesso! Faça login.", "success");
    document.getElementById("register-section").classList.remove("active");
    document.getElementById("login-section").classList.add("active");
  });

  // Login
  document.getElementById("loginForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const email = document.getElementById("loginEmail").value;
    const senha = document.getElementById("loginPassword").value;

    const res = await fetch(`${API_URL}/usuarios`);
    const users = await res.json();
    const user = users.find(u => u.email === email && u.senha === senha);

    if (user) {
      currentUser = user;
      showToast("Login realizado com sucesso!", "success");
      document.getElementById("userName").textContent = "👤 " + user.nome;
      document.getElementById("login-section").classList.remove("active");
      document.getElementById("list-section").classList.add("active");
      document.getElementById("logoutBtn").style.display = "inline-block";
      document.getElementById("menu").style.display = "flex";
      loadBooks();
    } else {
      showToast("Email ou senha incorretos.", "error");
    }
  });

  // Sair da conta
  document.getElementById("logoutBtn").addEventListener("click", () => {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.getElementById("login-section").classList.add("active");
    document.getElementById("logoutBtn").style.display = "none";
    document.getElementById("menu").style.display = "none";
    document.getElementById("userName").textContent = "";
    currentUser = null;
    showToast("Você saiu da conta.", "info");
  });

  // Navegação
  document.getElementById("goList").addEventListener("click", () => {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.getElementById("list-section").classList.add("active");
    loadBooks();
  });
  document.getElementById("goRegister").addEventListener("click", () => {
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.getElementById("system-section").classList.add("active");
  });

  // Carrega livros
  async function loadBooks() {
    const res = await fetch(`${API_URL}/livros`);
    const livros = await res.json();
    const list = document.getElementById("bookList");
    list.innerHTML = "";
    
    livros.forEach(livro => {
      const li = document.createElement("li");
      li.dataset.id = livro.id;
      li.innerHTML = `
        <div class="book-info">
          ${livro.imagemUrl ? `<img src="${livro.imagemUrl}" alt="Capa" class="book-cover">` : ""}
          <span><strong>${livro.nome}</strong> <br><em>${livro.genero}</em></span>
        </div>
        <div>
          <button onclick="viewBook('${livro.id}')">👁 Visualizar</button>
          <button onclick="editBook('${livro.id}')">✏️ Atualizar</button>
          <button onclick="removeBook('${livro.id}')">🗑 Excluir</button>
        </div>
      `;
      list.appendChild(li);
    });
  }

  // Visualizar livro
  async function viewBook(bookId) {
    const res = await fetch(`${API_URL}/livros/${bookId}`);
    const livro = await res.json();
    
    document.getElementById("modalTitle").textContent = "Detalhes do Livro";
    document.getElementById("viewTitle").textContent = livro.nome;
    document.getElementById("viewAuthor").textContent = livro.autor || "Não informado";
    document.getElementById("viewGenre").textContent = livro.genero;
    document.getElementById("viewYear").textContent = livro.ano || "Não informado";
    document.getElementById("viewDescription").textContent = livro.descricao;
    document.getElementById("viewImage").src = livro.imagemUrl || "";
    document.getElementById("viewContent").style.display = "block";
    document.getElementById("editForm").style.display = "none";
    document.getElementById("modal").style.display = "flex";
  }

  // Editar livro
  async function editBook(bookId) {
    const res = await fetch(`${API_URL}/livros/${bookId}`);
    const livro = await res.json();
    
    editingBook = livro;
    document.getElementById("modalTitle").textContent = "Editar Livro";
    document.getElementById("editTitle").value = livro.nome;
    document.getElementById("editAuthor").value = livro.autor || "";
    document.getElementById("editGenre").value = livro.genero;
    document.getElementById("editYear").value = livro.ano || "";
    document.getElementById("editDescription").value = livro.descricao;
    document.getElementById("editPreview").src = livro.imagemUrl || "";
    document.getElementById("viewContent").style.display = "none";
    document.getElementById("editForm").style.display = "block";
    document.getElementById("modal").style.display = "flex";
  }

  // Cadastrar livro
  const bookForm = document.getElementById("bookForm");
  const preview = document.getElementById("preview");

  document.getElementById("image").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        preview.src = reader.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    }
  });

  bookForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const nome = document.getElementById("title").value;
    const autor = document.getElementById("author").value;
    const genero = document.getElementById("genre").value;
    const ano = document.getElementById("year").value;
    const descricao = document.getElementById("description").value;
    const imagemUrl = preview.src || "";

    await fetch(`${API_URL}/livros`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ 
        nome, 
        autor, 
        genero, 
        ano, 
        descricao, 
        imagemUrl 
      }),
    });

    bookForm.reset();
    preview.src = "";
    preview.style.display = "none";
    showToast("Livro adicionado com sucesso!", "success");
    document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
    document.getElementById("list-section").classList.add("active");
    loadBooks();
  });

  // Atualizar imagem na edição
  document.getElementById("editImage").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = () => {
        document.getElementById("editPreview").src = reader.result;
      };
      reader.readAsDataURL(file);
    }
  });

  // Salvar edição
  document.getElementById("editForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (editingBook) {
      const livroAtualizado = {
        nome: document.getElementById("editTitle").value,
        autor: document.getElementById("editAuthor").value,
        genero: document.getElementById("editGenre").value,
        ano: document.getElementById("editYear").value,
        descricao: document.getElementById("editDescription").value,
        imagemUrl: document.getElementById("editPreview").src || editingBook.imagemUrl
      };

      await fetch(`${API_URL}/livros/${editingBook.id}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(livroAtualizado)
      });

      showToast("Livro atualizado com sucesso!", "success");
      document.getElementById("modal").style.display = "none";
      loadBooks();
    }
  });

  // Remover livro
  async function removeBook(bookId) {
    bookToDelete = bookId;
    const res = await fetch(`${API_URL}/livros/${bookId}`);
    const livro = await res.json();
    
    document.getElementById("confirmMessage").textContent = `Você deseja realmente remover o livro "${livro.nome}"?`;
    document.getElementById("confirmModal").style.display = "flex";
  }

  document.getElementById("cancelDelete").addEventListener("click", () => {
    bookToDelete = null;
    document.getElementById("confirmModal").style.display = "none";
  });

  document.getElementById("confirmDelete").addEventListener("click", async () => {
    if (bookToDelete) {
      await fetch(`${API_URL}/livros/${bookToDelete}`, {
        method: "DELETE"
      });
      
      showToast("Livro removido!", "error");
      bookToDelete = null;
      document.getElementById("confirmModal").style.display = "none";
      loadBooks();
    }
  });

  // Fechar modais
  document.getElementById("closeModal").addEventListener("click", () => {
    document.getElementById("modal").style.display = "none";
  });
  
  window.addEventListener("click", (e) => {
    if (e.target === document.getElementById("modal")) {
      document.getElementById("modal").style.display = "none";
    }
    if (e.target === document.getElementById("confirmModal")) {
      document.getElementById("confirmModal").style.display = "none";
    }
  });
  </script>
</body>
</html>